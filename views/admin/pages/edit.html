<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chỉnh sửa phim</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/filepond@^4/dist/filepond.css">
  <link rel="stylesheet" href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css">
  <!-- TinyMCE - CDN miễn phí, không cần API key -->
  <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js"></script>
</head>
<body>
  <!-- Placeholder cho header -->
  <div id="header-placeholder"></div>

  <!-- Placeholder cho sider -->
  <div id="sider-placeholder"></div>

  <!-- Main content -->
  <main class="main">
    <h1 class="box-title">Chỉnh sửa phim</h1>
    <div class="section-8">
      <form id="movie-edit-form">
        <div class="inner-group" style="display: none;">
          <input type="text" id="id" name="id">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="name">Tên phim</label>
          <input type="text" id="name" name="name">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="category">Thể loại</label>
          <select id="category" name="category">
            <option value="">-- Chọn thể loại --</option>
            <option value="hanh-dong">Hành động</option>
            <option value="hai">Hài hước</option>
            <option value="kinh-di">Kinh dị</option>
            <option value="tinh-cam">Tình cảm</option>
            <option value="khoa-hoc-vien-tuong">Khoa học viễn tưởng</option>
            <option value="hoat-hinh">Hoạt hình</option>
            <option value="phieu-luu">Phiêu lưu</option>
            <option value="tam-ly">Tâm lý</option>
            <option value="hinh-su">Hình sự</option>
            <option value="chien-tranh">Chiến tranh</option>
          </select>
        </div>

        <div class="inner-group">
          <label class="inner-label" for="position">Vị trí</label>
          <input type="number" id="position" name="position">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="status">Trạng thái</label>
          <select id="status" name="status">
            <option value="active">Hoạt động</option>
            <option value="inactive">Tạm dừng</option>
          </select>
        </div>

        <div class="inner-group inner-two-col">
          <label class="inner-label">Poster hiện tại</label>
          <img id="current-avatar" src="" alt="Poster hiện tại" style="width: 200px; height: 280px; object-fit: cover; border-radius: 8px; display: none;">
        </div>

        <div class="inner-group inner-two-col">
          <label class="inner-label" for="avatar">Đổi poster mới</label>
          <div class="inner-upload-image">
            <input type="file" id="avatar" name="avatar" accept="image/*">
          </div>
        </div>

        <div class="inner-group">
          <label class="inner-label" for="duration">Thời lượng</label>
          <input type="text" id="duration" name="duration">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="director">Đạo diễn</label>
          <input type="text" id="director" name="director">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="cast">Diễn viên</label>
          <input type="text" id="cast" name="cast">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="language">Ngôn ngữ</label>
          <input type="text" id="language" name="language">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="releaseDate">Ngày công chiếu</label>
          <input type="date" id="releaseDate" name="releaseDate">
        </div>

        <div class="inner-group">
          <label class="inner-label" for="ageRating">Phân loại độ tuổi</label>
          <select id="ageRating" name="ageRating">
            <option value="P">P - Phù hợp mọi lứa tuổi</option>
            <option value="T13">T13 - Không phù hợp dưới 13 tuổi</option>
            <option value="T16">T16 - Không phù hợp dưới 16 tuổi</option>
            <option value="T18">T18 - Không phù hợp dưới 18 tuổi</option>
            <option value="C">C - Cấm dưới 18 tuổi</option>
          </select>
        </div>

        <div class="inner-group">
          <label class="inner-label">Giá vé</label>
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div>
              <label>Ghế thường</label>
              <input type="number" name="priceStandard" min="0">
            </div>
            <div>
              <label>Ghế VIP</label>
              <input type="number" name="priceVip" min="0">
            </div>
            <div>
              <label>Ghế đôi</label>
              <input type="number" name="priceCouple" min="0">
            </div>
          </div>
        </div>

        <div class="inner-group">
          <label class="inner-label" for="trailer">Link trailer YouTube</label>
          <input type="text" id="trailer" name="trailer">
        </div>

        <div class="inner-group inner-two-col">
          <label class="inner-label" for="description">Mô tả phim</label>
          <textarea id="description" name="description"></textarea>
        </div>

        <div class="inner-group inner-two-col">
          <label class="inner-label" for="images">Thêm ảnh gallery (ảnh mới)</label>
          <div class="inner-upload-image-multi">
            <input type="file" multiple id="images" name="images" accept="image/*">
          </div>
        </div>

        <div class="inner-button inner-two-col">
          <button type="submit">Cập nhật</button>
        </div>
      </form>

      <div class="inner-back">
        <a href="index.html">Quay lại danh sách</a>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
  <script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>

  <script>
    // Load header
    fetch('partials/header.html')
      .then(response => response.text())
      .then(html => document.getElementById('header-placeholder').innerHTML = html)
      .catch(err => console.error('Lỗi load header:', err));

    // Load sider + gắn event menu mobile (chỉ sau khi load xong)
    fetch('partials/sider.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('sider-placeholder').innerHTML = html;

        // Gắn sự kiện menu mobile ngay sau khi insert HTML
        const buttonMenu = document.querySelector('.inner-button-menu');
        const sider = document.querySelector('.sider');
        const overlay = document.querySelector('.sider-overlay');

        if (buttonMenu && sider && overlay) {
          buttonMenu.addEventListener('click', () => {
            sider.classList.add('active');
            overlay.classList.add('active');
          });

          overlay.addEventListener('click', () => {
            sider.classList.remove('active');
            overlay.classList.remove('active');
          });
        } else {
          console.warn('Không tìm thấy các element menu mobile');
        }
      })
      .catch(err => console.error('Lỗi load sider:', err));

    // Lấy id từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    if (!id) {
      alert('Không tìm thấy ID phim trong URL');
      window.location.href = 'index.html';
    }
    document.getElementById('id').value = id;

    // Khởi tạo FilePond
    FilePond.registerPlugin(FilePondPluginImagePreview);

    const pondAvatar = FilePond.create(document.querySelector('#avatar'), {
      labelIdle: '+ <span class="filepond--label-action"></span>',
      imagePreviewMaxHeight: 280,
      stylePanelLayout: 'integrated circle'
    });

    const pondImages = FilePond.create(document.querySelector('#images'), {
      allowMultiple: true,
      labelIdle: '+ <span class="filepond--label-action"></span>',
      imagePreviewMaxHeight: 180,
      allowReorder: true
    });

    // Khởi tạo TinyMCE
    tinymce.init({
      selector: '#description',
      plugins: 'link image lists',
      toolbar: 'undo redo | bold italic | link image | bullist numlist',
      height: 300,
      setup: (editor) => {
        editor.on('init', () => {
          console.log('TinyMCE đã sẵn sàng');
        });
      }
    });

    // Load thông tin phim và điền vào form
    async function loadMovie() {
      try {
        const response = await axios.get(`http://localhost:3002/api/catalog/admin/movies/${id}`);
        const movie = response.data;
        console.log('Movie data loaded:', movie);

        // Điền dữ liệu vào các field
        document.getElementById('name').value = movie.name || '';
        document.getElementById('category').value = movie.category || '';
        document.getElementById('position').value = movie.position || '';
        document.getElementById('status').value = movie.status || 'active';
        document.getElementById('duration').value = movie.duration || '';
        document.getElementById('director').value = movie.director || '';
        document.getElementById('cast').value = movie.cast || '';
        document.getElementById('language').value = movie.language || '';

        if (movie.releaseDate) {
          const date = new Date(movie.releaseDate);
          document.getElementById('releaseDate').value = date.toISOString().split('T')[0];
        }

        document.getElementById('ageRating').value = movie.ageRating || 'P';
        document.getElementById('trailer').value = movie.trailer || '';

        // Giá vé
        if (movie.prices) {
          document.querySelector('input[name="priceStandard"]').value = movie.prices.standard || '';
          document.querySelector('input[name="priceVip"]').value = movie.prices.vip || '';
          document.querySelector('input[name="priceCouple"]').value = movie.prices.couple || '';
        }

        // Poster hiện tại
        if (movie.avatar) {
          document.getElementById('current-avatar').src = movie.avatar;
          document.getElementById('current-avatar').style.display = 'block';
        }

        // Mô tả (chờ TinyMCE init xong rồi set content)
        const checkTiny = setInterval(() => {
          if (tinymce.get('description')) {
            tinymce.get('description').setContent(movie.description || '');
            clearInterval(checkTiny);
          }
        }, 200);

        // Ảnh gallery cũ (FilePond add URL)
        if (movie.images && Array.isArray(movie.images) && movie.images.length > 0) {
          movie.images.forEach(url => {
            pondImages.addFile(url);
          });
        }

      } catch (error) {
        console.error('Lỗi load phim:', error);
        alert('Không thể tải thông tin phim. Kiểm tra console hoặc server.');
      }
    }

    loadMovie();

    // Submit form cập nhật
    document.getElementById('movie-edit-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData();
      formData.append('name', document.getElementById('name').value.trim());
      formData.append('category', document.getElementById('category').value);
      formData.append('position', document.getElementById('position').value || 0);
      formData.append('status', document.getElementById('status').value);
      formData.append('duration', document.getElementById('duration').value.trim());
      formData.append('director', document.getElementById('director').value.trim());
      formData.append('cast', document.getElementById('cast').value.trim());
      formData.append('language', document.getElementById('language').value.trim());
      formData.append('releaseDate', document.getElementById('releaseDate').value);
      formData.append('ageRating', document.getElementById('ageRating').value);
      formData.append('trailer', document.getElementById('trailer').value.trim());

      // Giá vé
      formData.append('priceStandard', document.querySelector('input[name="priceStandard"]').value || '');
      formData.append('priceVip', document.querySelector('input[name="priceVip"]').value || '');
      formData.append('priceCouple', document.querySelector('input[name="priceCouple"]').value || '');

      // Mô tả từ TinyMCE
      const description = tinymce.get('description')?.getContent() || document.getElementById('description').value;
      formData.append('description', description);

      // Avatar - chỉ append nếu có file mới
      if (pondAvatar.getFiles().length > 0) {
        formData.append('avatar', pondAvatar.getFiles()[0].file);
      }

      // Images - chỉ append file mới (không append URL cũ)
      pondImages.getFiles().forEach(file => {
        if (file.source instanceof File) { // Chỉ file mới upload
          formData.append('images', file.file);
        }
      });

      try {
        const response = await axios.put(`http://localhost:3002/api/catalog/admin/movies/${id}`, formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });

        if (response.data.code === 'success') {
          alert('Cập nhật phim thành công!');
          window.location.href = 'index.html';
        } else {
          alert('Lỗi từ server: ' + (response.data.message || 'Không xác định'));
        }
      } catch (error) {
        console.error('Lỗi cập nhật:', error);
        alert('Lỗi kết nối hoặc server: ' + (error.response?.data?.message || error.message));
      }
    });
  </script>
</body>
</html>