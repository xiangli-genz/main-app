extends ../layouts/default.pug
include ../mixins/options.pug

block main
  h1.box-title Thêm phim mới

  .section-8
    form#movie-create-form
      .inner-group
        label(class="inner-label" for="name") Tên phim
        input(type="text" id="name" name="name")
      
      .inner-group
        label(class="inner-label" for="category") Thể loại
        select(id="category" name="category")
          option(value="") -- Chọn thể loại --
          +options(categoryList, 0)
      
      .inner-group
        label(class="inner-label" for="position") Vị trí
        input(type="number" id="position" name="position")
      
      .inner-group
        label(class="inner-label" for="status") Trạng thái
        select(id="status" name="status")
          option(value="active") Hoạt động
          option(value="inactive") Dừng hoạt động
      
      .inner-group.inner-two-col
        label(class="inner-label" for="avatar") Poster phim
        div(class="inner-upload-image")
          input(type="file" id="avatar" accept="image/*" filepond-image name="avatar")
      
      .inner-group
        label(class="inner-label" for="duration") Thời lượng
        input(type="text" id="duration" name="duration" placeholder="VD: 120 phút")
      
      .inner-group
        label(class="inner-label" for="director") Đạo diễn
        input(type="text" id="director" name="director")
      
      .inner-group
        label(class="inner-label" for="cast") Diễn viên
        input(type="text" id="cast" name="cast")
      
      .inner-group
        label(class="inner-label" for="language") Ngôn ngữ
        input(type="text" id="language" name="language" placeholder="VD: Tiếng Anh - Phụ đề Việt")
      
      .inner-group
        label(class="inner-label" for="releaseDate") Ngày công chiếu
        input(type="date" id="releaseDate" name="releaseDate")
      
      .inner-group
        label(class="inner-label" for="ageRating") Phân loại độ tuổi
        select(id="ageRating" name="ageRating")
          option(value="P") P - Phù hợp mọi lứa tuổi
          option(value="T13") T13 - Không phù hợp dưới 13 tuổi
          option(value="T16") T16 - Không phù hợp dưới 16 tuổi
          option(value="T18") T18 - Không phù hợp dưới 18 tuổi
          option(value="C") C - Cấm dưới 18 tuổi
      
      .inner-group
        label(class="inner-label" for="trailer") Link trailer YouTube
        input(type="text" id="trailer" name="trailer")
      
      .inner-group
        label(class="inner-label") Giá vé
        .inner-input-list
          .inner-input-item
            label Ghế thường
            input(type="number" name="priceStandard" value="50000")
          .inner-input-item
            label Ghế VIP
            input(type="number" name="priceVip" value="60000")
          .inner-input-item
            label Ghế đôi
            input(type="number" name="priceCouple" value="110000")
      
      .inner-group.inner-two-col
        label(class="inner-label") Lịch chiếu
        .inner-schedule
          .inner-schedule-list
            .inner-schedule-item
              .inner-schedule-head
                span(class="inner-schedule-button inner-move")
                  <i class="fa-solid fa-up-down-left-right"></i>
                select(name="cinema" style="flex: 1; margin-right: 10px;")
                  option(value="") -- Chọn rạp --
                  each cinema in cinemaList
                    option(value=cinema.name) #{cinema.name}
                input(type="date" name="showtimeDate" style="width: 150px; margin-right: 10px;")
                input(type="text" name="showtimeTimes" placeholder="10:00,14:00,18:00" style="flex: 1; margin-right: 10px;")
                select(name="showtimeFormat" style="width: 100px; margin-right: 10px;")
                  option(value="2D") 2D
                  option(value="3D") 3D
                  option(value="IMAX") IMAX
                  option(value="4DX") 4DX
                span(class="inner-schedule-button inner-remove")
                  <i class="fa-regular fa-trash-can"></i>
          .inner-schedule-create + Thêm lịch chiếu
      
      .inner-group.inner-two-col
        label(class="inner-label" for="description") Mô tả phim
        textarea(id="description" textarea-mce name="description")
      
      .inner-group.inner-two-col
        label(class="inner-label" for="images") Danh sách ảnh
        div(class="inner-upload-image-multi")
          input(type="file" multiple data-allow-reorder="true" id="images" accept="image/*" filepond-image-multi name="images")
      
      .inner-button.inner-two-col
        button Tạo mới
    
    .inner-back
      a(href=`/${pathAdmin}/movie/list`) Quay lại danh sách

  script.
    // Xử lý thêm lịch chiếu
    document.addEventListener('DOMContentLoaded', function() {
      const scheduleSection = document.querySelector('.inner-schedule');
      const createBtn = scheduleSection.querySelector('.inner-schedule-create');
      const listContainer = scheduleSection.querySelector('.inner-schedule-list');
      
      createBtn.addEventListener('click', function() {
        const firstItem = listContainer.querySelector('.inner-schedule-item');
        const cloneItem = firstItem.cloneNode(true);
        
        // Reset values
        cloneItem.querySelectorAll('input, select').forEach(input => {
          if(input.type !== 'button') input.value = '';
        });
        
        listContainer.appendChild(cloneItem);
      });
      
      // Xử lý xóa item
      listContainer.addEventListener('click', function(e) {
        if(e.target.closest('.inner-remove')) {
          const items = listContainer.querySelectorAll('.inner-schedule-item');
          if(items.length > 1) {
            e.target.closest('.inner-schedule-item').remove();
          }
        }
      });
      
      // Xử lý submit form
      document.querySelector('#movie-create-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        
        // Thêm các field cơ bản
        formData.append('name', document.getElementById('name').value);
        formData.append('category', document.getElementById('category').value);
        formData.append('position', document.getElementById('position').value);
        formData.append('status', document.getElementById('status').value);
        formData.append('duration', document.getElementById('duration').value);
        formData.append('director', document.getElementById('director').value);
        formData.append('cast', document.getElementById('cast').value);
        formData.append('language', document.getElementById('language').value);
        formData.append('releaseDate', document.getElementById('releaseDate').value);
        formData.append('ageRating', document.getElementById('ageRating').value);
        formData.append('trailer', document.getElementById('trailer').value);
        
        // Giá vé
        formData.append('priceStandard', document.querySelector('[name="priceStandard"]').value);
        formData.append('priceVip', document.querySelector('[name="priceVip"]').value);
        formData.append('priceCouple', document.querySelector('[name="priceCouple"]').value);
        
        // Avatar
        if(filePond.avatar && filePond.avatar.getFiles().length > 0) {
          formData.append('avatar', filePond.avatar.getFiles()[0].file);
        }
        
        // Images
        if(filePondMulti.images && filePondMulti.images.getFiles().length > 0) {
          filePondMulti.images.getFiles().forEach(item => {
            formData.append('images', item.file);
          });
        }
        
        // Lịch chiếu
        const showtimes = [];
        document.querySelectorAll('.inner-schedule-item').forEach(item => {
          const cinema = item.querySelector('[name="cinema"]').value;
          const date = item.querySelector('[name="showtimeDate"]').value;
          const times = item.querySelector('[name="showtimeTimes"]').value.split(',').map(t => t.trim());
          const format = item.querySelector('[name="showtimeFormat"]').value;
          
          if(cinema && date && times.length > 0) {
            showtimes.push({ cinema, date, times, format });
          }
        });
        formData.append('showtimes', JSON.stringify(showtimes));
        
        // Description
        formData.append('description', tinymce.get('description').getContent());
        
        // Submit
        fetch(`/${pathAdmin}/movie/create`, {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          if(data.code === 'success') {
            window.location.href = `/${pathAdmin}/movie/list`;
          } else {
            alert(data.message);
          }
        });
      });
    });