extends ../layouts/default.pug

block main
  .booking-checkout-container
    .container
      // Progress Steps
      .booking-steps
        .step.completed
          .step-number 1
          .step-label Chọn ghế
        .step-arrow →
        .step.completed
          .step-number 2
          .step-label Chọn combo
        .step-arrow →
        .step.active
          .step-number 3
          .step-label Xác nhận
      
      .booking-checkout-layout
        // Left: Customer Info & Payment
        .checkout-section
          // Customer Information
          .section-card
            h3.section-title
              i.fa-solid.fa-user(style="margin-right: 10px;")
              | Xác Nhận Thông Tin Khách Hàng
            
            .form-group
              label(for="fullName") Họ và tên
                span.required *
              input#fullName(
                type="text" 
                placeholder="Nhập họ và tên"
                required
              )
            
            .form-row
              .form-group
                label(for="phone") Số điện thoại
                  span.required *
                input#phone(
                  type="tel" 
                  placeholder="Nhập số điện thoại"
                  required
                )
              
              .form-group
                label(for="email") Email
                input#email(
                  type="email" 
                  placeholder="Nhập email (không bắt buộc)"
                )
            
            .form-group
              label(for="note") Ghi chú
              textarea#note(
                rows="3"
                placeholder="Ghi chú thêm (không bắt buộc)"
              )
          
          // Payment Method
          .section-card
            h3.section-title
              i.fa-solid.fa-credit-card(style="margin-right: 10px;")
              | Phương Thức Thanh Toán
            
            .payment-methods
              .payment-option
                input#payment-money(
                  type="radio" 
                  name="paymentMethod" 
                  value="money"
                  checked
                )
                label(for="payment-money")
                  .payment-icon
                    i.fa-solid.fa-money-bill-wave
                  .payment-info
                    .payment-name Thanh toán tại quầy
                    .payment-desc Thanh toán bằng tiền mặt khi nhận vé
              
              .payment-option
                input#payment-zalopay(
                  type="radio" 
                  name="paymentMethod" 
                  value="zalopay"
                )
                label(for="payment-zalopay")
                  .payment-icon
                    i.fa-solid.fa-wallet
                  .payment-info
                    .payment-name ZaloPay
                    .payment-desc Thanh toán qua ví điện tử ZaloPay
              
              .payment-option
                input#payment-momo(
                  type="radio" 
                  name="paymentMethod" 
                  value="momo"
                )
                label(for="payment-momo")
                  .payment-icon
                    i.fa-solid.fa-mobile-screen
                  .payment-info
                    .payment-name Momo
                    .payment-desc Thanh toán qua ví điện tử Momo
              
              .payment-option
                input#payment-bank(
                  type="radio" 
                  name="paymentMethod" 
                  value="bank"
                )
                label(for="payment-bank")
                  .payment-icon
                    i.fa-solid.fa-building-columns
                  .payment-info
                    .payment-name Chuyển khoản ngân hàng
                    .payment-desc Chuyển khoản qua tài khoản ngân hàng
              
              // Bank Transfer Info (hidden by default)
              #bank-info.bank-transfer-info
                .bank-details
                  h4 Thông tin chuyển khoản
                  .bank-item
                    .bank-label Ngân hàng:
                    .bank-value Vietcombank
                  .bank-item
                    .bank-label Số tài khoản:
                    .bank-value 1234567890
                  .bank-item
                    .bank-label Chủ tài khoản:
                    .bank-value CÔNG TY TNHH RAP PHIM
                  .bank-item
                    .bank-label Nội dung:
                    .bank-value#transfer-content DV [Mã đặt vé]
        
        // Right: Booking Summary
        .summary-section
          .movie-info-card
            .movie-poster
              img(src=movieDetail.avatar alt=movieDetail.name)
            
            .movie-details
              h3.movie-title #{movieDetail.name}
              .movie-subtitle #{movieDetail.ageRating || 'P'} - #{movieDetail.language || 'Phụ đề'}
              
              .detail-row
                .detail-icon
                  i.fa-solid.fa-building
                .detail-content
                  .detail-label Rạp chiếu
                  .detail-value#cinema-display --
              
              .detail-row
                .detail-icon
                  i.fa-regular.fa-calendar
                .detail-content
                  .detail-label Ngày chiếu
                  .detail-value#date-display --
              
              .detail-row
                .detail-icon
                  i.fa-regular.fa-clock
                .detail-content
                  .detail-label Giờ chiếu
                  .detail-value#time-display --
              
              .detail-row
                .detail-icon
                  i.fa-solid.fa-film
                .detail-content
                  .detail-label Định dạng
                  .detail-value#format-display --
              
              .detail-row
                .detail-icon
                  i.fa-solid.fa-couch
                .detail-content
                  .detail-label Ghế ngồi
                  .detail-value#seats-display --
              
              .detail-row#combo-display-row(style="display: none;")
                .detail-icon
                  i.fa-solid.fa-popcorn
                .detail-content
                  .detail-label Combo đã chọn
                  .detail-value#combo-display --
          
          .price-summary
            h4.summary-title Thông Tin Thanh Toán
            
            .price-row
              span Tiền vé
              span#ticket-price 0đ
            
            .price-row#combo-price-row(style="display: none;")
              span Tiền combo
              span#combo-price 0đ
            
            .price-row#discount-row(style="display: none;")
              span Giảm giá
              span.discount-amount#discount-price -0đ
            
            .price-row.total-row
              strong Tổng thanh toán
              strong.total-amount#total-price 0đ
            
            .terms-checkbox
              input#accept-terms(type="checkbox")
              label(for="accept-terms") 
                | Tôi đồng ý với 
                a(href="#" target="_blank") Điều khoản & Điều kiện
          
          .action-buttons
            button.btn-back(onclick="history.back()") Quay lại
            button.btn-pay#btn-pay(disabled) Thanh toán

  style.
    .booking-checkout-container {
      background: #f5f5f5;
      padding: 30px 0 60px;
      min-height: 100vh;
    }
    
    .booking-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      background: #e0e0e0;
      color: #666;
    }
    
    .step.completed .step-number {
      background: #4CAF50;
      color: white;
    }
    
    .step.active .step-number {
      background: #2196F3;
      color: white;
    }
    
    .step-label {
      font-size: 14px;
      color: #666;
    }
    
    .step.active .step-label {
      color: #2196F3;
      font-weight: 600;
    }
    
    .step-arrow {
      margin: 0 20px;
      color: #bdbdbd;
      font-size: 24px;
    }
    
    .booking-checkout-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    
    .checkout-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .section-card {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin: 0 0 25px 0;
      display: flex;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .required {
      color: #EF5350;
      margin-left: 4px;
    }
    
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2196F3;
    }
    
    .form-group textarea {
      resize: vertical;
      font-family: inherit;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .payment-option {
      position: relative;
    }
    
    .payment-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .payment-option label {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-option input[type="radio"]:checked + label {
      border-color: #2196F3;
      background: #E3F2FD;
    }
    
    .payment-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 24px;
      color: #2196F3;
    }
    
    .payment-info {
      flex: 1;
    }
    
    .payment-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .payment-desc {
      font-size: 13px;
      color: #666;
    }
    
    .bank-transfer-info {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #FFF3E0;
      border-radius: 8px;
      border: 2px solid #FFB74D;
    }
    
    .bank-transfer-info.show {
      display: block;
    }
    
    .bank-details h4 {
      font-size: 16px;
      font-weight: 700;
      color: #F57C00;
      margin: 0 0 15px 0;
    }
    
    .bank-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #FFE0B2;
    }
    
    .bank-item:last-child {
      border-bottom: none;
    }
    
    .bank-label {
      font-size: 14px;
      color: #666;
    }
    
    .bank-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .summary-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: sticky;
      top: 20px;
      height: fit-content;
    }
    
    .movie-info-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .movie-poster {
      width: 100%;
      margin-bottom: 20px;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .movie-poster img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .movie-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #2196F3;
    }
    
    .movie-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .detail-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .detail-icon {
      width: 24px;
      color: #2196F3;
      margin-top: 2px;
    }
    
    .detail-content {
      flex: 1;
    }
    
    .detail-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 2px;
    }
    
    .detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .price-summary {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 20px 0;
      color: #333;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }
    
    .discount-amount {
      color: #4CAF50;
    }
    
    .price-row.total-row {
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
      font-size: 18px;
      color: #333;
      margin-bottom: 20px;
    }
    
    .total-amount {
      color: #EF5350;
      font-size: 24px;
    }
    
    .terms-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .terms-checkbox input[type="checkbox"] {
      margin-top: 4px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .terms-checkbox label {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }
    
    .terms-checkbox a {
      color: #2196F3;
      text-decoration: none;
    }
    
    .terms-checkbox a:hover {
      text-decoration: underline;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .btn-back,
    .btn-pay {
      height: 50px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-back {
      background: #e0e0e0;
      color: #666;
    }
    
    .btn-back:hover {
      background: #d5d5d5;
    }
    
    .btn-pay {
      background: #2196F3;
      color: white;
    }
    
    .btn-pay:hover:not(:disabled) {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .btn-pay:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    @media (max-width: 991.98px) {
      .booking-checkout-layout {
        grid-template-columns: 1fr;
      }
      
      .summary-section {
        position: static;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }

  script.
    // Seed demo bookingData into sessionStorage when missing (for testing)
    (function(){
      try{
        if(!sessionStorage.getItem('bookingData')){
          var demo = !{JSON.stringify(demoBookingData || null)};
          if(demo){
            sessionStorage.setItem('bookingData', JSON.stringify(demo));
            console.log('Demo bookingData seeded');
          }
        }
      }catch(e){console.error(e)}
    })();

    // Thay thế toàn bộ script block trong booking-checkout.pug
    document.addEventListener('DOMContentLoaded', function() {
      const isLoggedIn = #{user ? 'true' : 'false'};
      
      // Temporarily allow non-logged users to proceed (no redirect)
      if (!isLoggedIn) {
        console.warn('User not logged in — proceeding in demo mode.');
        // Optionally mark guest: bookingData = bookingData || {}; bookingData.guest = true;
      }
      
      let bookingData = JSON.parse(sessionStorage.getItem('bookingData') || 'null');
      
      if (!bookingData) {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');
        bookingData = cart.find(item => 
          (item.movieId && item.movieId === movieId) || 
          (item.tourId && item.tourId === movieId)
        );
      }
      
      if (!bookingData || !bookingData.seats) {
        alert('Không tìm thấy thông tin đặt vé. Vui lòng chọn lại ghế.');
        window.location.href = '/';
        return;
      }
      
      function normalizeSeats(seats) {
        if (!seats) return [];
        
        if (typeof seats === 'string') {
          try {
            seats = JSON.parse(seats);
          } catch(e) {
            console.error('Cannot parse seats:', e);
            return [];
          }
        }
        
        if (!Array.isArray(seats)) {
          console.error('Seats is not an array:', typeof seats);
          return [];
        }
        
        return seats.map(seat => {
          if (typeof seat === 'object' && seat !== null && seat.seatNumber) {
            return {
              seatNumber: seat.seatNumber,
              type: seat.type || 'standard',
              price: seat.price || 50000
            };
          }
          
          if (typeof seat === 'string') {
            try {
              const parsed = JSON.parse(seat);
              if (parsed.seatNumber) {
                return {
                  seatNumber: parsed.seatNumber,
                  type: parsed.type || 'standard',
                  price: parsed.price || 50000
                };
              }
            } catch(e) {
              // Không parse được
            }
            
            let type = 'standard';
            let price = 50000;
            
            if (seat.startsWith('V')) {
              type = 'vip';
              price = 60000;
            } else if (seat.startsWith('C') || seat.includes('-')) {
              type = 'couple';
              price = 110000;
            }
            
            return { seatNumber: seat, type: type, price: price };
          }
          
          console.error('Invalid seat format:', seat);
          return null;
        }).filter(Boolean);
      }
      
      bookingData.seats = normalizeSeats(bookingData.seats);
      
      console.log('=== Normalized booking data ===');
      console.log('seats:', bookingData.seats);
      
      const movieDetail = {
        avatar: bookingData.movieAvatar || '',
        name: bookingData.movieName || 'Đang tải...',
        ageRating: bookingData.ageRating || 'P',
        language: bookingData.language || 'Phụ đề'
      };
      
      document.getElementById('cinema-display').textContent = bookingData.cinema || '--';
      
      let dateDisplay = '--';
      if (bookingData.showtimeDate) {
        try {
          const dateObj = new Date(bookingData.showtimeDate);
          if (!isNaN(dateObj.getTime())) {
            dateDisplay = dateObj.toLocaleDateString('vi-VN');
          }
        } catch(e) {
          console.error('Date format error:', e);
        }
      }
      document.getElementById('date-display').textContent = dateDisplay;
      
      document.getElementById('time-display').textContent = bookingData.showtimeTime || '--';
      document.getElementById('format-display').textContent = bookingData.showtimeFormat || '--';
      document.getElementById('seats-display').textContent = 
        bookingData.seats.map(s => s.seatNumber).join(', ');
      
      if (bookingData.combos && Object.keys(bookingData.combos).length > 0) {
        const comboList = [];
        Object.keys(bookingData.combos).forEach(key => {
          const combo = bookingData.combos[key];
          if (combo && combo.quantity > 0) {
            comboList.push(`${combo.name} x${combo.quantity}`);
          }
        });
        
        if (comboList.length > 0) {
          document.getElementById('combo-display-row').style.display = 'flex';
          document.getElementById('combo-display').innerHTML = comboList.join('<br>');
        }
      }
      
      const ticketPrice = bookingData.ticketPrice || 0;
      let comboTotal = 0;
      
      if (bookingData.combos) {
        Object.keys(bookingData.combos).forEach(key => {
          const combo = bookingData.combos[key];
          if (combo && combo.quantity > 0) {
            comboTotal += (combo.price || 0) * (combo.quantity || 0);
          }
        });
      }
      
      const discount = 0;
      const total = ticketPrice + comboTotal - discount;
      
      document.getElementById('ticket-price').textContent = ticketPrice.toLocaleString('vi-VN') + 'đ';
      
      if (comboTotal > 0) {
        document.getElementById('combo-price-row').style.display = 'flex';
        document.getElementById('combo-price').textContent = comboTotal.toLocaleString('vi-VN') + 'đ';
      }
      
      if (discount > 0) {
        document.getElementById('discount-row').style.display = 'flex';
        document.getElementById('discount-price').textContent = '-' + discount.toLocaleString('vi-VN') + 'đ';
      }
      
      document.getElementById('total-price').textContent = total.toLocaleString('vi-VN') + 'đ';
      
      const paymentOptions = document.querySelectorAll('input[name="paymentMethod"]');
      const bankInfo = document.getElementById('bank-info');
      
      paymentOptions.forEach(option => {
        option.addEventListener('change', function() {
          if (this.value === 'bank') {
            bankInfo.classList.add('show');
          } else {
            bankInfo.classList.remove('show');
          }
        });
      });
      
      const acceptTerms = document.getElementById('accept-terms');
      const btnPay = document.getElementById('btn-pay');
      
      acceptTerms.addEventListener('change', function() {
        btnPay.disabled = !this.checked;
      });
      
      btnPay.addEventListener('click', function() {
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();
        const note = document.getElementById('note').value.trim();
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        
        if (!fullName) {
          alert('Vui lòng nhập họ tên!');
          document.getElementById('fullName').focus();
          return;
        }
        
        if (!phone) {
          alert('Vui lòng nhập số điện thoại!');
          document.getElementById('phone').focus();
          return;
        }
        
        const phoneRegex = /(84|0[3|5|7|8|9])+([0-9]{8})\b/g;
        if (!phoneRegex.test(phone)) {
          alert('Số điện thoại không đúng định dạng!');
          document.getElementById('phone').focus();
          return;
        }
        
        let showtimeDateISO;
        try {
          if (bookingData.showtimeDate instanceof Date) {
            showtimeDateISO = bookingData.showtimeDate.toISOString();
          } else {
            const dateObj = new Date(bookingData.showtimeDate);
            if (isNaN(dateObj.getTime())) {
              throw new Error('Invalid date');
            }
            showtimeDateISO = dateObj.toISOString();
          }
        } catch(e) {
          alert('Ngày chiếu không hợp lệ!');
          return;
        }
        
        const seatsPayload = bookingData.seats.map(seat => ({
          seatNumber: seat.seatNumber,
          type: seat.type || 'standard',
          price: seat.price || 50000
        }));
        
        const payload = {
          movieId: bookingData.movieId || bookingData.tourId,
          cinema: bookingData.cinema,
          showtimeDate: showtimeDateISO,
          showtimeTime: bookingData.showtimeTime,
          showtimeFormat: bookingData.showtimeFormat,
          seats: seatsPayload,
          combos: bookingData.combos || {},
          fullName: fullName,
          phone: phone,
          email: email,
          note: note,
          paymentMethod: paymentMethod
        };
        
        console.log('=== FINAL PAYLOAD ===');
        console.log('Full payload:', JSON.stringify(payload, null, 2));
        
        btnPay.disabled = true;
        btnPay.textContent = 'Đang xử lý...';
        
        fetch('/booking/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.code === 'success') {
            sessionStorage.removeItem('bookingData');
            
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart = cart.filter(item => 
              !(item.movieId === payload.movieId || item.tourId === payload.movieId)
            );
            localStorage.setItem('cart', JSON.stringify(cart));
            
            if (paymentMethod === 'zalopay') {
              window.location.href = `/booking/payment-zalopay?bookingId=${data.bookingId}`;
            } else {
              window.location.href = `/booking/success?bookingId=${data.bookingId}&phone=${phone}`;
            }
          } else {
            alert(data.message || 'Đặt vé thất bại. Vui lòng thử lại!');
            btnPay.disabled = false;
            btnPay.textContent = 'Thanh toán';
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Lỗi kết nối. Vui lòng thử lại!');
          btnPay.disabled = false;
          btnPay.textContent = 'Thanh toán';
        });
      });
    });