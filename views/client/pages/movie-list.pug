extends ../layouts/default.pug
include ../mixins/box-breadcrumb.pug
include ../mixins/product-item.pug

block main
  +box-breadcrumb(breadcrumb)
  
  .section-9
    .container
      .inner-wrap
        .inner-left
          .box-filter
            .inner-head
              .inner-title Bộ Lọc
              i.fa-solid.fa-filter
            .inner-body
              .inner-group
                .inner-label Rạp Chiếu
                select(name="cinema")
                  option(value="") -- Chọn rạp --
                  - const uniqueCinemas = [...new Set(movieList.flatMap(m => m.showtimes ? m.showtimes.map(s => s.cinema) : []))]
                  each cinema in uniqueCinemas
                    option(value=cinema) #{cinema}
              
              .inner-group
                .inner-label Thể loại
                select(name="categoryFilter")
                  option(value="") -- Chọn thể loại --
                  each cat in categoryList
                    option(value=cat.id) #{cat.name}
              
              .inner-group
                .inner-label Độ tuổi
                select(name="ageRating")
                  option(value="") -- Chọn độ tuổi --
                  option(value="P") P - Mọi lứa tuổi
                  option(value="T13") T13 - Trên 13 tuổi
                  option(value="T16") T16 - Trên 16 tuổi
                  option(value="T18") T18 - Trên 18 tuổi
                  option(value="C") C - Cấm dưới 18
              
              .inner-group
                .inner-label Định dạng
                select(name="format")
                  option(value="") -- Chọn định dạng --
                  option(value="2D") 2D
                  option(value="3D") 3D
                  option(value="IMAX") IMAX
                  option(value="4DX") 4DX
              
              .inner-group
                .inner-label Ngày chiếu
                input(type="date" name="showtimeDate")
              
              .inner-group
                .inner-label Mức giá vé
                select(name="priceRange")
                  option(value="") -- Chọn khoảng giá --
                  option(value="0-50000") Dưới 50.000đ
                  option(value="50000-70000") Từ 50.000đ - 70.000đ
                  option(value="70000-100000") Từ 70.000đ - 100.000đ
                  option(value="100000-150000") Từ 100.000đ - 150.000đ
                  option(value="150000-999999999") Trên 150.000đ
              
              .inner-group
                button.inner-button(type="button") Áp Dụng
          .inner-overlay
        
        .inner-right
          .inner-info
            h2.inner-title #{category.name}
            if category.description
              .inner-desc !{category.description}
          
          .inner-info-2
            .inner-sort
              .inner-label Sắp xếp:
              .inner-list
                button.active(data-sort="latest")
                  | Mới nhất
                  i.fa-solid.fa-arrow-down
                button(data-sort="price-asc")
                  | Giá tăng dần
                  i.fa-solid.fa-arrow-up
                button(data-sort="price-desc")
                  | Giá giảm dần
                  i.fa-solid.fa-arrow-down
                button(data-sort="name")
                  | Tên A-Z
                  i.fa-solid.fa-arrow-down
            .inner-count-record
              | Tất cả:
              b #{totalMovie} phim
            button.inner-filter-mobile
              span.inner-title Bộ Lọc
              i.fa-solid.fa-filter
          
          .inner-list-tour
            each item in movieList
              +product-item(item)
          
          if totalMovie === 0
            .text-center(style="padding: 40px 0; color: #666;")
              p Không tìm thấy phim nào phù hợp với bộ lọc của bạn

  script.
    document.addEventListener('DOMContentLoaded', function() {
      const filterBtn = document.querySelector('.box-filter .inner-button');
      const sortButtons = document.querySelectorAll('[data-sort]');
      
      // Sort functionality
      sortButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          sortButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const sortType = this.getAttribute('data-sort');
          const movieList = Array.from(document.querySelectorAll('.inner-list-tour .product-item'));
          const container = document.querySelector('.inner-list-tour');
          
          movieList.sort((a, b) => {
            if (sortType === 'latest') {
              return 0; // Keep original order
            } else if (sortType === 'price-asc') {
              const priceA = parseInt(a.querySelector('.inner-price-new')?.textContent.replace(/[^\d]/g, '') || 0);
              const priceB = parseInt(b.querySelector('.inner-price-new')?.textContent.replace(/[^\d]/g, '') || 0);
              return priceA - priceB;
            } else if (sortType === 'price-desc') {
              const priceA = parseInt(a.querySelector('.inner-price-new')?.textContent.replace(/[^\d]/g, '') || 0);
              const priceB = parseInt(b.querySelector('.inner-price-new')?.textContent.replace(/[^\d]/g, '') || 0);
              return priceB - priceA;
            } else if (sortType === 'name') {
              const nameA = a.querySelector('.inner-title a')?.textContent.trim() || '';
              const nameB = b.querySelector('.inner-title a')?.textContent.trim() || '';
              return nameA.localeCompare(nameB);
            }
            return 0;
          });
          
          movieList.forEach(item => container.appendChild(item));
        });
      });
      
      // Filter functionality
      if (filterBtn) {
        filterBtn.addEventListener('click', function() {
          const url = new URL(window.location.href);
          
          const cinema = document.querySelector('[name="cinema"]').value;
          const categoryFilter = document.querySelector('[name="categoryFilter"]').value;
          const ageRating = document.querySelector('[name="ageRating"]').value;
          const format = document.querySelector('[name="format"]').value;
          const showtimeDate = document.querySelector('[name="showtimeDate"]').value;
          const priceRange = document.querySelector('[name="priceRange"]').value;
          
          // Update URL params
          if (cinema) url.searchParams.set('cinema', cinema);
          else url.searchParams.delete('cinema');
          
          if (categoryFilter) url.searchParams.set('categoryFilter', categoryFilter);
          else url.searchParams.delete('categoryFilter');
          
          if (ageRating) url.searchParams.set('ageRating', ageRating);
          else url.searchParams.delete('ageRating');
          
          if (format) url.searchParams.set('format', format);
          else url.searchParams.delete('format');
          
          if (showtimeDate) url.searchParams.set('showtimeDate', showtimeDate);
          else url.searchParams.delete('showtimeDate');
          
          if (priceRange) url.searchParams.set('priceRange', priceRange);
          else url.searchParams.delete('priceRange');
          
          window.location.href = url.href;
        });
      }
      
      // Set filter values from URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('cinema')) document.querySelector('[name="cinema"]').value = urlParams.get('cinema');
      if (urlParams.get('categoryFilter')) document.querySelector('[name="categoryFilter"]').value = urlParams.get('categoryFilter');
      if (urlParams.get('ageRating')) document.querySelector('[name="ageRating"]').value = urlParams.get('ageRating');
      if (urlParams.get('format')) document.querySelector('[name="format"]').value = urlParams.get('format');
      if (urlParams.get('showtimeDate')) document.querySelector('[name="showtimeDate"]').value = urlParams.get('showtimeDate');
      if (urlParams.get('priceRange')) document.querySelector('[name="priceRange"]').value = urlParams.get('priceRange');
    });