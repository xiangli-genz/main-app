extends ../layouts/default.pug

block main
  .section-12
    .container
      .inner-wrap
        h2.inner-title-main Đăng Nhập
        form#user-login-form
          .inner-info
            .inner-inputs
              .inner-input
                input#email-input(
                  placeholder="Email *" 
                  name="email" 
                  type="email"
                )
              .inner-input
                input#password-input(
                  placeholder="Mật khẩu *" 
                  name="password" 
                  type="password"
                )
            .inner-meta
              .inner-confirm
                input#remember-password(
                  type="checkbox"
                  name="rememberPassword"
                  class="inner-check"
                )
                label(for="remember-password") Nhớ mật khẩu
              a(href="/user/forgot-password") Quên mật khẩu?
          .inner-button
            button(type="submit") Đăng Nhập
        .inner-more
          span Chưa có tài khoản?
          a(href="/user/register") Đăng ký
  script.
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('user-login-form');
      
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const emailInput = document.getElementById('email-input');
          const passwordInput = document.getElementById('password-input');
          const rememberPassword = document.getElementById('remember-password').checked;
          
          const email = emailInput.value.trim();
          const password = passwordInput.value;
          
          if (!email) {
            alert('Vui lòng nhập email!');
            emailInput.focus();
            return;
          }
          
          if (!password) {
            alert('Vui lòng nhập mật khẩu!');
            passwordInput.focus();
            return;
          }
          
          const formData = {
            email: email,
            password: password,
            rememberPassword: rememberPassword
          };
          
          fetch('/user/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          })
          .then(res => res.json())
          .then(data => {
            if (data.code === 'success') {
              // Kiểm tra xem có URL redirect không
              const redirectUrl = sessionStorage.getItem('redirectAfterLogin');
              
              if (redirectUrl) {
                // Xóa URL redirect khỏi sessionStorage
                sessionStorage.removeItem('redirectAfterLogin');
                // Redirect về trang đã lưu
                window.location.href = redirectUrl;
              } else {
                // Redirect về trang chủ nếu không có URL saved
                window.location.href = '/';
              }
            } else {
              alert(data.message || 'Đăng nhập thất bại!');
            }
          })
          .catch(err => {
            console.error('Error:', err);
            alert('Có lỗi xảy ra. Vui lòng thử lại!');
          });
        });
      }
    });