extends ../layouts/default.pug
include ../mixins/box-breadcrumb.pug

block main
  +box-breadcrumb(breadcrumb)
  
  // Main booking layout
  .booking-container
    .container
      .booking-layout
        // Left: Seat Map
        .seat-section
          // Cinema, Date, Time Selection
          .booking-info
            .info-group
              label Chọn rạp chiếu
              select#cinema-select(name="cinema")
                option(value="") -- Chọn rạp --
                each cinema in cinemaList
                  option(value=cinema.name) #{cinema.name}
            
            .info-group
              label Chọn ngày chiếu
              select#date-select(name="showtimeDate" disabled)
                option(value="") -- Chọn ngày --
            
            .info-group
              label Chọn suất chiếu
              select#time-select(name="showtimeTime" disabled)
                option(value="") -- Chọn giờ chiếu --
          
          // Legend
          .seat-legend-top
            .legend-item
              .legend-icon.seat-empty Ghế trống
            .legend-item
              .legend-icon.seat-selecting Ghế đang chọn
            .legend-item
              .legend-icon.seat-booked Ghế đã đặt
          
          // Screen
          .screen-wrapper
            .screen-label MÀN HÌNH CHIẾU
          
          // Seat Grid
          .seat-grid-container
            - const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J']
            - const seatsPerRow = 10
            - const vipRows = ['F', 'G', 'H', 'I']
            - const coupleRows = ['J']
            
            each row in rows
              .seat-row
                each val, colIndex in Array(seatsPerRow)
                  - const seatNumber = row + (colIndex + 1)
                  - let seatClass = 'seat-normal'
                  - let seatType = 'standard'
                  - let seatPrice = movieDetail.prices ? movieDetail.prices.standard : 50000
                  
                  - if (vipRows.includes(row)) {
                  -   seatClass = 'seat-vip'
                  -   seatType = 'vip'
                  -   seatPrice = movieDetail.prices ? movieDetail.prices.vip : 60000
                  - }
                  - if (coupleRows.includes(row)) {
                  -   seatClass = 'seat-couple'
                  -   seatType = 'couple'
                  -   seatPrice = movieDetail.prices ? movieDetail.prices.couple : 110000
                  - }
                  
                  if coupleRows.includes(row) && colIndex % 2 === 0
                    - const coupleNum = row + (colIndex + 1) + '-' + row + (colIndex + 2)
                    .seat(
                      class=seatClass
                      data-seat=coupleNum
                      data-type='couple'
                      data-price=seatPrice
                      style="min-width: 70px;"
                    ) #{coupleNum}
                  else if !coupleRows.includes(row)
                    .seat(
                      class=seatClass
                      data-seat=seatNumber
                      data-type=seatType
                      data-price=seatPrice
                    ) #{seatNumber}
          
          // Bottom Legend
          .seat-legend-bottom
            .legend-row
              .legend-item-bottom
                .seat.seat-normal Ghế thường
              .legend-item-bottom
                .seat.seat-vip Ghế VIP
              .legend-item-bottom
                .seat.seat-couple(style="min-width: 70px;") Ghế đôi
            .price-info
              .total-section
                .total-label Tổng tiền
                .total-amount 0 vnđ
              .timer-section
                .timer-label Thời gian
                .timer-countdown 10:00
        
        // Right: Movie Info
        .info-section
          .movie-poster
            img(src=movieDetail.avatar alt=movieDetail.name)
          
          .movie-details
            h2.movie-title #{movieDetail.name}
            .movie-subtitle #{movieDetail.ageRating || 'P'} - #{movieDetail.language || 'Phụ đề'}
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-tags
              .detail-content
                .detail-label Thể loại
                .detail-value #{movieDetail.category || 'Hành động'}
            
            .detail-row
              .detail-icon
                i.fa-regular.fa-clock
              .detail-content
                .detail-label Thời lượng
                .detail-value #{movieDetail.duration || '120 phút'}
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-user-tie
              .detail-content
                .detail-label Đạo diễn
                .detail-value #{movieDetail.director || 'Đang cập nhật'}
            
            hr.divider
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-building
              .detail-content
                .detail-label Rạp chiếu
                .detail-value#cinema-display --
            
            .detail-row
              .detail-icon
                i.fa-regular.fa-calendar
              .detail-content
                .detail-label Ngày chiếu
                .detail-value#date-display --
            
            .detail-row
              .detail-icon
                i.fa-regular.fa-clock
              .detail-content
                .detail-label Giờ chiếu
                .detail-value#time-display --
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-film
              .detail-content
                .detail-label Định dạng
                .detail-value#format-display --
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-couch
              .detail-content
                .detail-label Ghế ngồi
                .detail-value#seats-display --
            
            .continue-btn
              button#btn-continue(data-movie-id=movieDetail.id) TIẾP TỤC

  style.
    .booking-container {
      background: #f5f5f5;
      padding: 20px 0 60px;
    }
    
    .booking-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
    }
    
    /* Seat Section */
    .seat-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
    }
    
    .booking-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .info-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .info-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .info-group select:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }
    
    .seat-legend-top {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .legend-icon {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    
    .legend-icon.seat-empty {
      background: #e0e0e0;
      border: 2px solid #bdbdbd;
    }
    
    .legend-icon.seat-selecting {
      background: #2196F3;
      border: 2px solid #1976D2;
      color: white;
    }
    
    .legend-icon.seat-booked {
      background: #757575;
      border: 2px solid #616161;
      color: #999;
    }
    
    .screen-wrapper {
      margin: 30px 0;
      position: relative;
    }
    
    .screen-wrapper::before {
      content: '';
      display: block;
      width: 100%;
      height: 4px;
      background: linear-gradient(to bottom, #999, #333);
      border-radius: 0 0 50% 50%;
      margin-bottom: 15px;
    }
    
    .screen-label {
      text-align: center;
      color: #999;
      font-size: 14px;
      letter-spacing: 2px;
      margin-bottom: 30px;
    }
    
    .seat-grid-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .seat-row {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    
    .seat {
      min-width: 36px;
      height: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid;
    }
    
    .seat-normal {
      background: #e0e0e0;
      border-color: #bdbdbd;
      color: #666;
    }
    
    .seat-vip {
      background: #FFD700;
      border-color: #FFC700;
      color: #333;
    }
    
    .seat-couple {
      background: #EF5350;
      border-color: #E53935;
      color: white;
    }
    
    .seat:hover:not(.seat-booked):not(.seat-disabled) {
      transform: scale(1.1);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    
    .seat.selected {
      background: #2196F3 !important;
      border-color: #1976D2 !important;
      color: white !important;
    }
    
    .seat.seat-booked {
      background: #757575 !important;
      border-color: #616161 !important;
      color: #999 !important;
      cursor: not-allowed !important;
    }
    
    .seat-legend-bottom {
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .legend-row {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .legend-item-bottom {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-item-bottom .seat {
      cursor: default;
    }
    
    .price-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 2px solid #ddd;
    }
    
    .total-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .total-label {
      font-size: 14px;
      color: #666;
    }
    
    .total-amount {
      font-size: 18px;
      font-weight: 700;
      color: #EF5350;
    }
    
    .timer-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .timer-label {
      font-size: 14px;
      color: #666;
    }
    
    .timer-countdown {
      font-size: 20px;
      font-weight: 700;
      color: #333;
    }
    
    /* Info Section */
    .info-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    
    .movie-poster {
      width: 100%;
      margin-bottom: 20px;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .movie-poster img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .movie-title {
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #2196F3;
    }
    
    .movie-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .detail-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 14px;
    }
    
    .detail-icon {
      width: 24px;
      color: #2196F3;
      margin-top: 2px;
    }
    
    .detail-content {
      flex: 1;
    }
    
    .detail-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 2px;
    }
    
    .detail-value {
      font-weight: 600;
      color: #333;
    }
    
    .divider {
      margin: 20px 0;
      border: none;
      border-top: 1px solid #e0e0e0;
    }
    
    .continue-btn {
      margin-top: 30px;
    }
    
    .continue-btn button {
      width: 100%;
      height: 50px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .continue-btn button:hover:not(:disabled) {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .continue-btn button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    @media (max-width: 991.98px) {
      .booking-layout {
        grid-template-columns: 1fr;
      }
      
      .info-section {
        position: static;
      }
      
      .booking-info {
        grid-template-columns: 1fr;
      }
    }

  script.
    document.addEventListener('DOMContentLoaded', function() {
      const movieId = '#{movieDetail.id}';
      const isLoggedIn = #{user ? 'true' : 'false'}; // Check if user is logged in
      let selectedSeats = [];
      let bookedSeats = [];
      let countdownTimer;
      let timeRemaining = 600;
      let autoRefreshInterval;
      
      const cinemaSelect = document.getElementById('cinema-select');
      const dateSelect = document.getElementById('date-select');
      const timeSelect = document.getElementById('time-select');
      const btnContinue = document.getElementById('btn-continue');
      
      const showtimesGrouped = !{JSON.stringify(showtimesGrouped || {})};
      
      console.log('Showtimes grouped:', showtimesGrouped);
      
      // Update date options khi chọn rạp
      cinemaSelect.addEventListener('change', function() {
        const selectedCinema = this.value;
        
        dateSelect.innerHTML = '<option value="">-- Chọn ngày --</option>';
        timeSelect.innerHTML = '<option value="">-- Chọn giờ chiếu --</option>';
        timeSelect.disabled = true;
        
        clearAutoRefresh();
        
        if (selectedCinema && showtimesGrouped[selectedCinema]) {
          dateSelect.disabled = false;
          
          Object.keys(showtimesGrouped[selectedCinema]).forEach(dateKey => {
            const showtime = showtimesGrouped[selectedCinema][dateKey];
            const option = document.createElement('option');
            option.value = dateKey;
            option.setAttribute('data-format', showtime.format);
            option.textContent = `${showtime.dateFormat} - ${showtime.dayOfWeek}`;
            dateSelect.appendChild(option);
          });
        } else {
          dateSelect.disabled = true;
        }
        
        updateDisplay();
      });
      
      dateSelect.addEventListener('change', function() {
        const selectedCinema = cinemaSelect.value;
        const selectedDate = this.value;
        
        timeSelect.innerHTML = '<option value="">-- Chọn giờ chiếu --</option>';
        
        clearAutoRefresh();
        
        if (selectedCinema && selectedDate && showtimesGrouped[selectedCinema][selectedDate]) {
          timeSelect.disabled = false;
          
          const times = showtimesGrouped[selectedCinema][selectedDate].times;
          times.forEach(time => {
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeSelect.appendChild(option);
          });
        } else {
          timeSelect.disabled = true;
        }
        
        updateDisplay();
      });
      
      timeSelect.addEventListener('change', function() {
        updateDisplay();
        loadBookedSeats();
        startAutoRefresh();
      });
      
      function updateDisplay() {
        const cinema = cinemaSelect.value;
        const dateValue = dateSelect.value;
        const dateOption = dateSelect.options[dateSelect.selectedIndex];
        const dateText = dateOption ? dateOption.text : '--';
        const time = timeSelect.value || '--';
        const format = dateOption ? dateOption.getAttribute('data-format') : '--';
        
        document.getElementById('cinema-display').textContent = cinema || '--';
        document.getElementById('date-display').textContent = dateText;
        document.getElementById('time-display').textContent = time;
        document.getElementById('format-display').textContent = format;
      }
      
      function startAutoRefresh() {
        clearAutoRefresh();
        autoRefreshInterval = setInterval(() => {
          loadBookedSeats(true);
        }, 10000);
      }
      
      function clearAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }
      
      async function loadBookedSeats(silent = false) {
        if (!cinemaSelect.value || !dateSelect.value || !timeSelect.value) {
          return;
        }
        
        if (!silent) {
          selectedSeats = [];
          document.querySelectorAll('.seat.selected').forEach(seat => {
            seat.classList.remove('selected');
          });
          updateTotalPrice();
          updateSeatsDisplay();
        }
        
        try {
          const response = await fetch(
            `/movie/booked-seats?movieId=${movieId}&cinema=${encodeURIComponent(cinemaSelect.value)}&date=${dateSelect.value}&time=${encodeURIComponent(timeSelect.value)}`
          );
          const data = await response.json();
          
          if (data.code === 'success') {
            const oldBookedSeats = [...bookedSeats];
            bookedSeats = data.bookedSeats || [];
            
            const newlyBooked = bookedSeats.filter(seat => !oldBookedSeats.includes(seat));
            
            if (silent && newlyBooked.length > 0) {
              const conflictSeats = selectedSeats.filter(seat => bookedSeats.includes(seat));
              
              if (conflictSeats.length > 0) {
                selectedSeats = selectedSeats.filter(seat => !bookedSeats.includes(seat));
                updateTotalPrice();
                updateSeatsDisplay();
                
                alert(`Ghế ${conflictSeats.join(', ')} vừa được người khác đặt. Vui lòng chọn ghế khác!`);
              }
            }
            
            updateSeatDisplay();
          }
        } catch (error) {
          console.error('Error loading booked seats:', error);
        }
      }
      
      function updateSeatDisplay() {
        document.querySelectorAll('.seat').forEach(seat => {
          const seatNumber = seat.getAttribute('data-seat');
          
          seat.classList.remove('seat-booked', 'selected');
          
          if (bookedSeats.includes(seatNumber)) {
            seat.classList.add('seat-booked');
            seat.style.cursor = 'not-allowed';
          } else {
            seat.style.cursor = 'pointer';
            if (selectedSeats.includes(seatNumber)) {
              seat.classList.add('selected');
            }
          }
        });
      }
      
      function startCountdown() {
        updateCountdownDisplay();
        countdownTimer = setInterval(() => {
          timeRemaining--;
          if (timeRemaining <= 0) {
            clearInterval(countdownTimer);
            alert('Hết thời gian giữ ghế!');
            window.location.reload();
          }
          updateCountdownDisplay();
        }, 1000);
      }
      
      function updateCountdownDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.querySelector('.timer-countdown').textContent = 
          `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }
      
      // ===== THÊM KIỂM TRA ĐĂNG NHẬP KHI CHỌN GHẾ =====
      document.querySelectorAll('.seat').forEach(seat => {
        seat.addEventListener('click', function() {
          // Kiểm tra đăng nhập
          if (!isLoggedIn) {
            if (confirm('Bạn cần đăng nhập để đặt vé. Chuyển đến trang đăng nhập?')) {
              // Lưu URL hiện tại để redirect sau khi đăng nhập
              sessionStorage.setItem('redirectAfterLogin', window.location.href);
              window.location.href = '/user/login';
            }
            return;
          }
          
          if (this.classList.contains('seat-booked')) return;
          
          if (!timeSelect.value) {
            alert('Vui lòng chọn suất chiếu trước!');
            return;
          }
          
          const seatNumber = this.getAttribute('data-seat');
          const index = selectedSeats.indexOf(seatNumber);
          
          if (index > -1) {
            selectedSeats.splice(index, 1);
            this.classList.remove('selected');
          } else {
            selectedSeats.push(seatNumber);
            this.classList.add('selected');
          }
          
          updateTotalPrice();
          updateSeatsDisplay();
        });
      });
      // =================================================
      
      function updateTotalPrice() {
        let total = 0;
        selectedSeats.forEach(seatNumber => {
          const seatEl = document.querySelector(`[data-seat="${seatNumber}"]`);
          if (seatEl) {
            total += parseInt(seatEl.getAttribute('data-price')) || 0;
          }
        });
        
        document.querySelector('.total-amount').textContent = 
          total.toLocaleString('vi-VN') + ' vnđ';
      }
      
      function updateSeatsDisplay() {
        const display = document.getElementById('seats-display');
        display.textContent = selectedSeats.length > 0 ? selectedSeats.join(', ') : '--';
      }
      
      // Continue button
      btnContinue.addEventListener('click', function() {
        // Kiểm tra đăng nhập
        if (!isLoggedIn) {
          if (confirm('Bạn cần đăng nhập để tiếp tục đặt vé. Chuyển đến trang đăng nhập?')) {
            sessionStorage.setItem('redirectAfterLogin', window.location.href);
            window.location.href = '/user/login';
          }
          return;
        }
        
        if (!cinemaSelect.value || !dateSelect.value || !timeSelect.value) {
          alert('Vui lòng chọn đầy đủ thông tin rạp, ngày và giờ chiếu!');
          return;
        }
        
        if (selectedSeats.length === 0) {
          alert('Vui lòng chọn ít nhất 1 ghế!');
          return;
        }
        
        const movieId = this.getAttribute('data-movie-id');
        const cinema = cinemaSelect.value;
        const dateValue = dateSelect.value;
        const dateOption = dateSelect.options[dateSelect.selectedIndex];
        
        let dateISO;
        try {
          const dateObj = new Date(dateValue);
          if (isNaN(dateObj.getTime())) {
            throw new Error('Invalid date');
          }
          dateISO = dateObj.toISOString();
        } catch(e) {
          alert('Ngày chiếu không hợp lệ!');
          return;
        }
        
        const time = timeSelect.value;
        const format = dateOption.getAttribute('data-format');
        
        const seatObjects = selectedSeats.map(seatNumber => {
          const seatEl = document.querySelector(`[data-seat="${seatNumber}"]`);
          return {
            seatNumber: seatNumber,
            type: seatEl ? seatEl.getAttribute('data-type') : 'standard',
            price: seatEl ? parseInt(seatEl.getAttribute('data-price')) : 50000
          };
        });
        
        let ticketPrice = 0;
        seatObjects.forEach(seat => {
          ticketPrice += seat.price;
        });
        
        const bookingData = {
          movieId: movieId,
          movieName: '#{movieDetail.name}',
          movieAvatar: '#{movieDetail.avatar}',
          ageRating: '#{movieDetail.ageRating || "P"}',
          language: '#{movieDetail.language || "Phụ đề"}',
          cinema: cinema,
          showtimeDate: dateISO,
          showtimeTime: time,
          showtimeFormat: format,
          seats: seatObjects,
          combos: {},
          ticketPrice: ticketPrice
        };
        
        sessionStorage.setItem('bookingData', JSON.stringify(bookingData));
        
        console.log('=== Booking data saved ===');
        console.log(bookingData);
        
        window.location.href = `/booking/combo?movieId=${movieId}`;
      });
    });