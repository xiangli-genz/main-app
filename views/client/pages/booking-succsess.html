<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt vé thành công</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Loading State -->
        <div id="loading-state" style="text-align: center; padding: 80px 20px;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 48px; color: var(--color-secondary);"></i>
            <p style="margin-top: 20px; color: #666;">Đang tải thông tin đặt vé...</p>
        </div>

        <!-- Success Content -->
        <div class="success-container" id="success-content" style="display: none;">
            <div class="success-icon">
                <i class="fa-solid fa-circle-check"></i>
            </div>
            
            <h2 class="success-title">Đặt Vé Thành Công!</h2>
            
            <div class="booking-code">
                <i class="fa-solid fa-ticket"></i> Mã đặt vé: <strong id="booking-code-display">-</strong>
            </div>
            
            <p class="success-message" id="success-message">
                <!-- Dynamic message -->
            </p>
            
            <!-- Movie Info -->
            <div class="ticket-info">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img id="success-movie-avatar" src="" alt="Movie" 
                         style="width: 200px; height: 300px; border-radius: 12px; object-fit: cover; display: none;">
                </div>
                
                <h3 id="success-movie-name" style="color: var(--color-primary); margin-bottom: 15px; text-align: center;">
                    -
                </h3>
                
                <div class="info-row">
                    <span><i class="fa-solid fa-building"></i> Rạp chiếu:</span>
                    <strong id="success-cinema">-</strong>
                </div>
                
                <div class="info-row">
                    <span><i class="fa-solid fa-calendar"></i> Ngày chiếu:</span>
                    <strong id="success-date">-</strong>
                </div>
                
                <div class="info-row">
                    <span><i class="fa-solid fa-clock"></i> Suất chiếu:</span>
                    <strong id="success-time">-</strong>
                </div>
                
                <div class="info-row">
                    <span><i class="fa-solid fa-couch"></i> Ghế ngồi:</span>
                    <strong id="success-seats">-</strong>
                </div>
                
                <div class="info-row" id="combo-row" style="display: none;">
                    <span><i class="fa-solid fa-popcorn"></i> Combo:</span>
                    <strong id="success-combos">-</strong>
                </div>
                
                <div class="info-row" style="border-top: 2px solid #e0e0e0; padding-top: 15px; margin-top: 15px;">
                    <span style="font-size: 18px;">Tổng tiền:</span>
                    <strong id="success-total" style="font-size: 24px; color: var(--color-danger);">-</strong>
                </div>
                
                <div class="info-row">
                    <span><i class="fa-solid fa-wallet"></i> Phương thức:</span>
                    <strong id="success-payment-method">-</strong>
                </div>
                
                <div class="info-row">
                    <span><i class="fa-solid fa-check-circle"></i> Trạng thái:</span>
                    <strong id="success-payment-status" style="color: var(--color-success);">-</strong>
                </div>
            </div>
            
            <!-- Customer Info -->
            <div class="ticket-info" style="margin-top: 20px;">
                <h4 style="color: var(--color-primary); margin-bottom: 15px;">
                    <i class="fa-solid fa-user"></i> Thông Tin Khách Hàng
                </h4>
                
                <div class="info-row">
                    <span>Họ tên:</span>
                    <strong id="success-customer-name">-</strong>
                </div>
                
                <div class="info-row">
                    <span>Số điện thoại:</span>
                    <strong id="success-customer-phone">-</strong>
                </div>
                
                <div class="info-row" id="email-row" style="display: none;">
                    <span>Email:</span>
                    <strong id="success-customer-email">-</strong>
                </div>
            </div>
            
            <!-- Payment Instructions (for cash) -->
            <div id="cash-payment-notice" class="payment-info-box" style="display: none; background: #fff3cd; border: 2px solid #ffc107; margin-top: 20px;">
                <h4 style="color: #856404; margin-bottom: 15px;">
                    <i class="fa-solid fa-info-circle"></i> Hướng Dẫn Thanh Toán
                </h4>
                <ul style="color: #856404; padding-left: 20px; margin: 0;">
                    <li style="margin-bottom: 10px;">Vui lòng đến quầy vé của rạp chiếu trước giờ chiếu ít nhất 15 phút</li>
                    <li style="margin-bottom: 10px;">Xuất trình mã đặt vé: <strong id="cash-booking-code">-</strong></li>
                    <li style="margin-bottom: 10px;">Thanh toán số tiền: <strong id="cash-total-amount">-</strong></li>
                    <li>Nhận vé và combo (nếu có) tại quầy</li>
                </ul>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="printTicket()">
                    <i class="fa-solid fa-print"></i> In vé
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='/'">
                    <i class="fa-solid fa-home"></i> Về trang chủ
                </button>
            </div>
            
            <!-- Additional Info -->
            <p style="text-align: center; color: #999; font-size: 13px; margin-top: 30px;">
                <i class="fa-solid fa-phone"></i> Hotline hỗ trợ: <strong style="color: var(--color-secondary);">1900 xxxx</strong>
            </p>
        </div>

        <!-- Error State -->
        <div id="error-state" style="display: none; text-align: center; padding: 80px 20px;">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 48px; color: #EF5350;"></i>
            <h3 style="margin-top: 20px; color: var(--color-primary);">Không tìm thấy thông tin đặt vé</h3>
            <p style="color: #666; margin-top: 10px;">Vui lòng kiểm tra lại hoặc liên hệ hotline để được hỗ trợ.</p>
            <button class="btn btn-primary" onclick="window.location.href='/'" style="margin-top: 20px;">
                <i class="fa-solid fa-home"></i> Về trang chủ
            </button>
        </div>
    </div>

    <script>
        // Get booking ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('bookingId');
        
        console.log('=== SUCCESS PAGE ===');
        console.log('Booking ID from URL:', bookingId);
        
        // Load booking info
        async function loadBookingInfo() {
            const loadingState = document.getElementById('loading-state');
            const successContent = document.getElementById('success-content');
            const errorState = document.getElementById('error-state');
            
            if (!bookingId) {
                console.error('❌ No booking ID in URL');
                if (loadingState) loadingState.style.display = 'none';
                if (errorState) errorState.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}`);
                const data = await response.json();
                
                if (data.code === 'success' && data.data.booking) {
                    const booking = data.data.booking;
                    
                    // Hide loading, show success
                    loadingState.style.display = 'none';
                    successContent.style.display = 'block';
                    
                    // Update UI
                    updateSuccessPage(booking);
                    
                    // Clear session storage
                    sessionStorage.removeItem('bookingData');
                    
                } else {
                    throw new Error('Booking not found');
                }
                
            } catch (error) {
                console.error('Error loading booking:', error);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
            }
        }
        
        // Update success page with booking data
        function updateSuccessPage(booking) {
            // Booking code
            document.getElementById('booking-code-display').textContent = booking.bookingCode;
            
            // Success message
            const messageEl = document.getElementById('success-message');
            if (booking.paymentStatus === 'paid') {
                messageEl.innerHTML = 'Cảm ơn bạn đã đặt vé! Vé của bạn đã được thanh toán thành công.<br>Vui lòng đến rạp trước giờ chiếu ít nhất 15 phút.';
            } else {
                messageEl.innerHTML = 'Cảm ơn bạn đã đặt vé! Vui lòng thanh toán tại quầy vé trước giờ chiếu.';
                
                // Show cash payment notice
                const cashNotice = document.getElementById('cash-payment-notice');
                cashNotice.style.display = 'block';
                document.getElementById('cash-booking-code').textContent = booking.bookingCode;
                document.getElementById('cash-total-amount').textContent = formatPrice(booking.total);
            }
            
            // Movie info
            if (booking.movieAvatar) {
                const avatarEl = document.getElementById('success-movie-avatar');
                avatarEl.src = booking.movieAvatar;
                avatarEl.style.display = 'block';
            }
            
            document.getElementById('success-movie-name').textContent = booking.movieName || '-';
            document.getElementById('success-cinema').textContent = booking.cinema || '-';
            
            // Date & Time
            if (booking.showtime) {
                const dateObj = new Date(booking.showtime.date);
                document.getElementById('success-date').textContent = dateObj.toLocaleDateString('vi-VN');
                document.getElementById('success-time').textContent = 
                    `${booking.showtime.time} - ${booking.showtime.format || '2D'}`;
            }
            
            // Seats
            if (booking.seats && booking.seats.length > 0) {
                const seatNumbers = booking.seats.map(s => s.seatNumber).join(', ');
                document.getElementById('success-seats').textContent = seatNumbers;
            }
            
            // Combos
            if (booking.combos && booking.combos.length > 0) {
                const comboRow = document.getElementById('combo-row');
                comboRow.style.display = 'flex';
                
                const comboTexts = booking.combos.map(c => 
                    `${c.name} (x${c.quantity})`
                ).join(', ');
                document.getElementById('success-combos').textContent = comboTexts;
            }
            
            // Prices
            document.getElementById('success-total').textContent = formatPrice(booking.total);
            
            // Payment info
            const paymentMethods = {
                'cash': 'Tiền mặt',
                'momo': 'Ví MoMo',
                'zalopay': 'ZaloPay',
                'vnpay': 'VNPay',
                'bank': 'Chuyển khoản'
            };
            document.getElementById('success-payment-method').textContent = 
                paymentMethods[booking.paymentMethod] || booking.paymentMethod;
            
            const paymentStatuses = {
                'paid': 'Đã thanh toán',
                'unpaid': 'Chưa thanh toán'
            };
            const statusEl = document.getElementById('success-payment-status');
            statusEl.textContent = paymentStatuses[booking.paymentStatus] || booking.paymentStatus;
            statusEl.style.color = booking.paymentStatus === 'paid' ? 
                'var(--color-success)' : 'var(--color-warning)';
            
            // Customer info
            document.getElementById('success-customer-name').textContent = booking.fullName || '-';
            document.getElementById('success-customer-phone').textContent = booking.phone || '-';
            
            if (booking.email) {
                const emailRow = document.getElementById('email-row');
                emailRow.style.display = 'flex';
                document.getElementById('success-customer-email').textContent = booking.email;
            }
        }
        
        // Print ticket
        function printTicket() {
            window.print();
        }
        
        // Format price
        function formatPrice(price) {
            return price.toLocaleString('vi-VN') + 'đ';
        }
        
        // Load booking on page load
        loadBookingInfo();
    </script>
</body>
</html>